<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Impostor Online - Wybór Trybu</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <style>
        body { background-color: #1a1a1a; font-family: 'Segoe UI', sans-serif; color: white; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .container { background: #fff; color: #333; padding: 30px; border-radius: 20px; width: 90%; max-width: 400px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .hidden { display: none !important; }
        input { width: 100%; padding: 12px; margin: 10px 0; border: 2px solid #eee; border-radius: 10px; box-sizing: border-box; }
        button { width: 100%; padding: 14px; cursor: pointer; border: none; border-radius: 10px; font-weight: bold; margin-top: 10px; transition: 0.2s; }
        .btn-create { background: #28a745; color: white; }
        .btn-join { background: #007bff; color: white; }
        .btn-start { background: #ffc107; color: #333; font-size: 1.2em; }
        #playerList { text-align: left; background: #f8f9fa; padding: 15px; border-radius: 10px; margin: 15px 0; border: 1px solid #ddd; color: #444; }
        .badge-host { background: #28a745; color: white; padding: 2px 8px; border-radius: 5px; font-size: 0.8em; margin-left: 10px; }
    </style>
</head>
<body>

    <div id="screen-start" class="container">
        <h1 style="color:#333; margin-bottom: 25px;">Impostor Game</h1>
        <input type="text" id="input-name" placeholder="Twoje imię">
        <input type="text" id="input-room" placeholder="Kod pokoju (np. 789)">
        
        <div style="margin-top: 20px;">
            <button class="btn-create" onclick="handleGame('create')">STWÓRZ NOWY POKÓJ</button>
            <p style="color: #888; margin: 5px 0;">lub</p>
            <button class="btn-join" onclick="handleGame('join')">DOŁĄCZ DO ISTNIEJĄCEGO</button>
        </div>
    </div>

    <div id="screen-lobby" class="container hidden">
        <h2>Pokój: <span id="room-id-text" style="color:#007bff"></span></h2>
        <div id="playerList">Czekam na graczy...</div>
        
        <div id="host-panel" class="hidden">
            <p style="color: #28a745;"><b>Jesteś organizatorem (Host)</b></p>
            <button class="btn-start" onclick="startGame()">ROZPOCZNIJ GRĘ</button>
        </div>

        <div id="guest-panel">
            <p><small>Czekaj, aż Host kliknie Start...</small></p>
        </div>
    </div>

    <div id="screen-game" class="container hidden">
        <h2 id="role-text">Rola</h2>
        <p id="question-text" style="font-size: 1.3em; font-weight: bold; margin: 20px 0;"></p>
        <div id="input-area">
            <input type="text" id="input-answer" placeholder="Twoja odpowiedź...">
            <button class="btn-join" onclick="submitAnswer()">WYŚLIJ</button>
        </div>
        <p id="wait-others" class="hidden" style="color: #28a745; font-weight: bold;">Wysłano! Czekamy na resztę...</p>
    </div>

    <div id="screen-results" class="container hidden">
        <h2>Wyniki Debaty</h2>
        <div id="results-list" style="text-align: left;"></div>
        <button class="btn-join" onclick="location.reload()">ZAGRAJ PONOWNIE</button>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAQLLZui2v4j3nLLKXhp2brcqsgSyy0W2s",
            authDomain: "menu-gier.firebaseapp.com",
            databaseURL: "https://menu-gier-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "menu-gier",
            storageBucket: "menu-gier.firebasedatabase.app",
            messagingSenderId: "442961627931",
            appId: "1:442961627931:web:26453bd5720da6037d21be"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let myName = "";
        let myRoom = "";
        let isHost = false;

        const DATABASE_QUESTIONS = [
            { crew: "Ulubiony deser?", imp: "Co jest najbardziej gorzkie?" },
            { crew: "Gdzie na spacer?", imp: "Gdzie jest najbrudniej?" },
            { crew: "Pizza", imp: "Kebab" },
            { crew: "Twój ulubiony kolor?", imp: "Kolor, którego nie lubisz?" }
        ];

        window.handleGame = function(mode) {
            myName = document.getElementById('input-name').value.trim();
            myRoom = document.getElementById('input-room').value.trim();

            if (!myName || !myRoom) return alert("Podaj imię i kod!");

            const roomRef = db.ref('games/' + myRoom);

            roomRef.once('value').then(snap => {
                const data = snap.val();

                if (mode === 'create') {
                    if (data && data.host) {
                        return alert("Ten pokój już istnieje! Wybierz inny kod lub dołącz.");
                    }
                    isHost = true;
                    roomRef.set({ host: myName, status: "LOBBY" });
                } else {
                    if (!data) return alert("Pokój nie istnieje! Najpierw go stwórz.");
                }

                // Dodanie gracza
                db.ref(`games/${myRoom}/players/${myName}`).set({
                    name: myName,
                    answer: "",
                    isImp: false
                });

                if (isHost) {
                    document.getElementById('host-panel').classList.remove('hidden');
                    document.getElementById('guest-panel').classList.add('hidden');
                }

                startSync();
                showScreen('screen-lobby');
                document.getElementById('room-id-text').innerText = myRoom;
            });
        };

        function startSync() {
            db.ref(`games/${myRoom}`).on('value', snap => {
                const data = snap.val();
                if (!data) return;

                // Aktualizacja listy graczy
                const players = data.players || {};
                const list = document.getElementById('playerList');
                list.innerHTML = "<b>Gracze:</b><br>";
                Object.keys(players).forEach(p => {
                    const hostLabel = p === data.host ? '<span class="badge-host">HOST</span>' : '';
                    list.innerHTML += `• ${p} ${hostLabel}<br>`;
                });

                // Start gry
                if (data.status === "STARTED" && document.getElementById('screen-game').classList.contains('hidden')) {
                    const me = players[myName];
                    showScreen('screen-game');
                    document.getElementById('role-text').innerText = me.isImp ? "JESTEŚ IMPOSTOREM" : "JESTEŚ ZAŁOGANTEM";
                    document.getElementById('role-text').style.color = me.isImp ? "red" : "green";
                    document.getElementById('question-text').innerText = me.isImp ? data.qSet.imp : data.qSet.crew;
                }

                // Wyniki
                if (data.status === "RESULTS") {
                    showFinalResults(data);
                }
            });
        }

        window.startGame = function() {
            db.ref(`games/${myRoom}/players`).once('value', snap => {
                const players = snap.val();
                const names = Object.keys(players);
                if (names.length < 2) return alert("Potrzeba min. 2 graczy!");

                const imp = names[Math.floor(Math.random() * names.length)];
                const q = DATABASE_QUESTIONS[Math.floor(Math.random() * DATABASE_QUESTIONS.length)];

                const updates = {};
                names.forEach(n => updates[`players/${n}/isImp`] = (n === imp));
                updates['status'] = "STARTED";
                updates['qSet'] = q;

                db.ref(`games/${myRoom}`).update(updates);
            });
        };

        window.submitAnswer = function() {
            const ans = document.getElementById('input-answer').value.trim();
            if (!ans) return alert("Wpisz cokolwiek!");

            db.ref(`games/${myRoom}/players/${myName}`).update({ answer: ans }).then(() => {
                document.getElementById('input-area').classList.add('hidden');
                document.getElementById('wait-others').classList.remove('hidden');
                if (isHost) checkAnswers();
            });
        };

        function checkAnswers() {
            db.ref(`games/${myRoom}/players`).once('value', snap => {
                const all = Object.values(snap.val());
                if (all.every(p => p.answer !== "")) {
                    db.ref(`games/${myRoom}`).update({ status: "RESULTS" });
                }
            });
        }

        function showFinalResults(data) {
            showScreen('screen-results');
            const area = document.getElementById('results-list');
            area.innerHTML = `<p style="background:#eee; padding:10px;">Pytanie załogi: <b>${data.qSet.crew}</b></p>`;
            
            Object.values(data.players).forEach(p => {
                area.innerHTML += `<p><b>${p.name}:</b> ${p.answer} ${p.isImp ? '<b style="color:red">[IMP]</b>' : ''}</p>`;
            });
        }

        function showScreen(id) {
            document.querySelectorAll('.container').forEach(c => c.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        }
    </script>
</body>
</html>
