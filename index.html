<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Test: Evolution ðŸ§¬</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --accent: #38bdf8; --success: #22c55e; --xp: #f59e0b; --text: #f8fafc; }
        body { background: var(--bg); font-family: 'Segoe UI', Tahoma, sans-serif; color: var(--text); margin: 0; display: flex; justify-content: center; min-height: 100vh; }
        .container { width: 95%; max-width: 500px; padding: 20px; }
        .card { background: var(--card); padding: 25px; border-radius: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.4); margin-bottom: 20px; border: 1px solid #334155; text-align: center; }
        .hidden { display: none !important; }
        
        /* Progress & Levels */
        .level-badge { background: var(--xp); color: #000; padding: 6px 18px; border-radius: 50px; font-weight: 800; display: inline-block; margin-bottom: 15px; text-transform: uppercase; font-size: 0.8em; }
        .xp-bar { width: 100%; height: 12px; background: #334155; border-radius: 6px; margin: 15px 0; overflow: hidden; border: 1px solid #475569; }
        .xp-fill { height: 100%; background: linear-gradient(90deg, #f59e0b, #fbbf24); transition: width 0.6s cubic-bezier(0.34, 1.56, 0.64, 1); }

        input { width: 100%; padding: 14px; margin: 10px 0; border-radius: 12px; border: 1px solid #334155; background: #0f172a; color: white; box-sizing: border-box; font-size: 16px; }
        button { width: 100%; padding: 16px; margin: 10px 0; border: none; border-radius: 14px; font-weight: bold; cursor: pointer; transition: transform 0.2s, background 0.2s; font-size: 1em; }
        button:active { transform: scale(0.98); }
        .btn-primary { background: var(--accent); color: #0f172a; }
        .btn-opt { background: #334155; color: white; border: 1px solid #475569; }
        
        .game-item { background: #1e293b; border: 2px solid #334155; padding: 15px; border-radius: 16px; margin: 10px 0; cursor: pointer; text-align: left; transition: 0.3s; }
        .game-item:hover { border-color: var(--accent); background: #263349; }
        .game-item .badge-turn { float: right; background: var(--success); color: white; padding: 2px 8px; border-radius: 6px; font-size: 0.7em; }
        
        .option-grid { display: grid; grid-template-columns: 1fr; gap: 10px; margin-top: 20px; }
        .status-tag { color: var(--accent); font-weight: bold; font-size: 0.9em; margin-top: 15px; display: block; }
    </style>
</head>
<body>

    <div class="container">
        <div id="screen-auth" class="card">
            <h1 style="margin-bottom: 5px;">The Test</h1>
            <p style="color: #94a3b8; margin-top: 0;">Zsynchronizuj swojÄ… relacjÄ™</p>
            <input type="text" id="login-nick" placeholder="Twoje imiÄ™ / Nick">
            <input type="password" id="login-pin" placeholder="TwÃ³j PIN (np. 1234)">
            <button class="btn-primary" onclick="handleLogin()">ZALOGUJ / STWÃ“RZ KONTO</button>
        </div>

        <div id="screen-menu" class="card hidden">
            <div class="level-badge">Zalogowano jako <span id="display-name">...</span></div>
            <h3 style="text-align: left; margin-top: 20px;">Twoje aktywne gry:</h3>
            <div id="games-list"></div>
            
            <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #334155;">
                <p style="font-size: 0.9em; color: #94a3b8;">Zacznij nowÄ… grÄ™ z kimÅ›:</p>
                <input type="text" id="target-nick" placeholder="Wpisz dokÅ‚adnie Nick partnera">
                <button class="btn-primary" onclick="startNewRelation()">ROZPOCZNIJ NOWY TEST</button>
                <button class="btn-opt" style="margin-top: 20px; color: #94a3b8; font-size: 0.8em;" onclick="logout()">WYLOGUJ SIÄ˜</button>
            </div>
        </div>

        <div id="screen-game" class="card hidden">
            <div id="relation-stats">
                <div class="level-badge" id="rel-level">POZIOM 1</div>
                <div class="xp-bar"><div id="rel-xp-fill" class="xp-fill"></div></div>
                <p id="rel-info" style="font-size: 0.8em; color: #94a3b8;"></p>
            </div>
            
            <h2 id="q-text" style="margin: 30px 0 10px 0;">...</h2>
            <div id="options-area" class="option-grid"></div>
            
            <span id="game-status" class="status-tag"></span>
            <button class="btn-opt" style="margin-top: 30px;" onclick="showMenu()">WRÃ“Ä† DO LISTY GIER</button>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAQLLZui2v4j3nLLKXhp2brcqsgSyy0W2s",
            databaseURL: "https://menu-gier-default-rtdb.europe-west1.firebasedatabase.app",
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let currentUser = null;
        let activeRelId = null;

        const QUESTIONS = [
            { q: "Gdzie widzisz siÄ™ za 10 lat?", o: ["WÅ‚asna firma / Kariera", "PodrÃ³Å¼owanie po Å›wiecie", "Spokojne Å¼ycie rodzinne"] },
            { q: "Jaka jest Twoja najgorsza cecha?", o: ["Lenistwo i prokrastynacja", "Brak cierpliwoÅ›ci / NerwowoÅ›Ä‡", "Zbyt duÅ¼e gadulstwo"] },
            { q: "TwÃ³j idealny wieczÃ³r to:", o: ["Impreza i duÅ¼o ludzi", "Cisza, Netflix i jedzenie", "DÅ‚ugi spacer lub sport"] },
            { q: "Kto z nas ma trudniejszy charakter?", o: ["Zdecydowanie ja", "Druga osoba", "JesteÅ›my tak samo trudni"] },
            { q: "GdybyÅ›my wygrali milion, to:", o: ["Inwestujemy w przyszÅ‚oÅ›Ä‡", "Wydajemy na marzenia od razu", "Rozdajemy / Pomagamy innym"] },
            { q: "Czego najbardziej nie lubisz robiÄ‡?", o: ["SprzÄ…tania / Gotowania", "Wstawania wczeÅ›nie rano", "ZaÅ‚atwiania spraw urzÄ™dowych"] }
        ];

        // LOGOWANIE
        function handleLogin() {
            const nick = document.getElementById('login-nick').value.trim();
            const pin = document.getElementById('login-pin').value.trim();
            if(!nick || pin.length < 4) return alert("Podaj Nick i min. 4-cyfrowy PIN");

            db.ref('evo_v2/users/' + nick).once('value', snap => {
                if(snap.exists()) {
                    if(snap.val().pin === pin) success(nick);
                    else alert("BÅ‚Ä™dny PIN dla tego uÅ¼ytkownika!");
                } else {
                    db.ref('evo_v2/users/' + nick).set({ nick, pin }).then(() => success(nick));
                }
            });
        }

        function success(nick) {
            currentUser = nick;
            localStorage.setItem('theTest_v2_nick', nick);
            showMenu();
        }

        function logout() {
            localStorage.clear();
            location.reload();
        }

        function showMenu() {
            hideAll();
            document.getElementById('screen-menu').classList.remove('hidden');
            document.getElementById('display-name').innerText = currentUser;
            loadGamesList();
        }

        // LISTA RELACJI
        function loadGamesList() {
            db.ref('evo_v2/relations').on('value', snap => {
                const list = document.getElementById('games-list');
                list.innerHTML = "";
                const data = snap.val() || {};
                let found = false;

                Object.keys(data).forEach(id => {
                    if(id.includes(currentUser)) {
                        found = true;
                        const rel = data[id];
                        const partner = id.replace(currentUser, "").replace("_", "");
                        const isMyTurn = (rel.turn === currentUser);
                        
                        const div = document.createElement('div');
                        div.className = "game-item";
                        div.innerHTML = `
                            ${isMyTurn ? '<span class="badge-turn">TWÃ“J RUCH</span>' : ''}
                            <strong>Relacja z: ${partner}</strong><br>
                            <small style="color: #94a3b8">Poziom ${rel.level} â€¢ ZgodnoÅ›Ä‡ ${rel.total > 0 ? Math.round(rel.correct/rel.total*100) : 0}%</small>
                        `;
                        div.onclick = () => openGame(id, partner);
                        list.appendChild(div);
                    }
                });
                if(!found) list.innerHTML = "<p style='color:#64748b; font-size: 0.9em;'>Nie masz jeszcze Å¼adnych gier. Dodaj kogoÅ› poniÅ¼ej!</p>";
            });
        }

        function startNewRelation() {
            const target = document.getElementById('target-nick').value.trim();
            if(!target || target === currentUser) return alert("Podaj poprawny nick partnera!");

            const relId = [currentUser, target].sort().join("_");
            db.ref('evo_v2/relations/' + relId).once('value', snap => {
                if(!snap.exists()) {
                    db.ref('evo_v2/relations/' + relId).set({
                        level: 1, xp: 0, turn: currentUser, step: "ASKING",
                        currentQ: Math.floor(Math.random()*QUESTIONS.length),
                        correct: 0, total: 0
                    });
                }
                openGame(relId, target);
            });
        }

        // GRA
        function openGame(relId, partner) {
            activeRelId = relId;
            hideAll();
            document.getElementById('screen-game').classList.remove('hidden');
            
            db.ref('evo_v2/relations/' + relId).on('value', snap => {
                const d = snap.val();
                if(!d || activeRelId !== relId) return;

                // Statystyki
                document.getElementById('rel-level').innerText = `POZIOM ${d.level}`;
                document.getElementById('rel-xp-fill').style.width = (d.xp / (d.level * 200) * 100) + "%";
                document.getElementById('rel-info').innerText = `ZgodnoÅ›Ä‡: ${d.correct}/${d.total} poprawnych`;

                const q = QUESTIONS[d.currentQ];
                const optArea = document.getElementById('options-area');
                optArea.innerHTML = "";

                if(d.turn === currentUser) {
                    document.getElementById('q-text').innerText = q.q;
                    document.getElementById('game-status').innerText = d.step === "ASKING" ? "Pytanie o Ciebie:" : `Co wybraÅ‚ partner (${partner})?`;
                    
                    q.o.forEach(opt => {
                        const b = document.createElement('button');
                        b.className = "btn-opt";
                        b.innerText = opt;
                        b.onclick = () => handleAction(relId, d, opt, partner);
                        optArea.appendChild(b);
                    });
                } else {
                    document.getElementById('q-text').innerText = "Czekamy na ruch...";
                    document.getElementById('game-status').innerText = `Teraz kolej uÅ¼ytkownika ${partner}`;
                }
            });
        }

        function handleAction(relId, data, val, partner) {
            const ref = db.ref('evo_v2/relations/' + relId);
            
            if(data.step === "ASKING") {
                // Ja odpowiadam o sobie, tura przechodzi na partnera by zgadÅ‚
                ref.update({
                    lastAns: val,
                    step: "GUESSING",
                    turn: partner
                });
            } else {
                // Ja zgadujÄ™ co wybraÅ‚ partner
                const match = (data.lastAns === val);
                let xp = data.xp + (match ? 60 : 15);
                let lvl = data.level;
                if(xp >= lvl * 200) { xp = 0; lvl++; }

                ref.update({
                    xp: xp,
                    level: lvl,
                    correct: data.correct + (match ? 1 : 0),
                    total: data.total + 1,
                    currentQ: Math.floor(Math.random() * QUESTIONS.length),
                    step: "ASKING",
                    turn: partner // Teraz partner odpowiada o sobie
                });
                alert(match ? "TRAFIONE! +60 XP âœ¨" : "PUDÅO! Ale i tak dostajecie +15 XP za prÃ³bÄ™. ðŸ™ƒ");
            }
        }

        function hideAll() {
            document.querySelectorAll('.card').forEach(c => c.classList.add('hidden'));
        }

        // Auto-login
        const saved = localStorage.getItem('theTest_v2_nick');
        if(saved) { currentUser = saved; showMenu(); }
    </script>
</body>
</html>
