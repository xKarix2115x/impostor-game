<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MultiGame Online</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <style>
        :root { --bg: #121212; --card: #1e1e1e; --primary: #007bff; --secondary: #6f42c1; --success: #28a745; --danger: #dc3545; }
        body { background-color: var(--bg); font-family: 'Segoe UI', sans-serif; color: #fff; margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .container { background: var(--card); padding: 30px; border-radius: 25px; box-shadow: 0 15px 35px rgba(0,0,0,0.5); text-align: center; width: 90%; max-width: 450px; border: 1px solid #333; }
        .hidden { display: none !important; }
        
        button { width: 100%; padding: 15px; margin: 8px 0; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; transition: 0.2s; font-size: 1em; }
        .btn-blue { background: var(--primary); color: white; }
        .btn-green { background: var(--success); color: white; }
        .btn-opt { background: #2a2a2a; color: white; border: 2px solid #444; }
        input, select { width:100%; padding:12px; margin:10px 0; border-radius:8px; background:#2a2a2a; color:white; border:1px solid #444; box-sizing: border-box; }
        
        /* Karty Impostor */
        .player-card { position: relative; width: 160px; height: 220px; margin: 20px auto; transform-style: preserve-3d; transition: transform 0.6s; cursor: pointer; }
        .player-card.flipped { transform: rotateY(180deg); }
        .card-front, .card-back { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 3px solid #333; padding: 15px; box-sizing: border-box; }
        .card-front { background: var(--primary); color: white; }
        .card-back { transform: rotateY(180deg); color: white; text-align: center; }
        .impostor-bg { background: var(--danger); }
        .crew-bg { background: var(--success); }

        /* Progress Bar The Test */
        .progress-bar { width: 100%; height: 8px; background: #333; border-radius: 4px; margin: 15px 0; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--primary); transition: width 0.3s; }
        .reveal-text { color: var(--danger); font-weight: bold; border: 1px dashed var(--danger); padding: 2px; }
    </style>
</head>
<body>

    <div id="screen-auth" class="container">
        <h1 style="color:var(--primary)">Party Game</h1>
        <input type="text" id="input-name" placeholder="Twoje imię">
        <input type="text" id="input-room" placeholder="Kod pokoju">
        <button class="btn-green" onclick="handleAuth('create')">STWÓRZ POKÓJ</button>
        <button class="btn-blue" onclick="handleAuth('join')">DOŁĄCZ DO GRY</button>
    </div>

    <div id="screen-lobby" class="container hidden">
        <h2>Pokój: <span id="room-id-display" style="color:var(--primary)"></span></h2>
        <div id="playerList" style="margin: 15px 0; color: #aaa;"></div>
        <div id="host-panel" class="hidden">
            <label>Wybierz tryb:</label>
            <select id="select-mode" onchange="toggleImpSettings()">
                <option value="THE_TEST">THE TEST (2 osoby)</option>
                <option value="IMPOSTOR_KARTY">IMPOSTOR: KARTY</option>
                <option value="IMPOSTOR_PYTANIA">IMPOSTOR: PYTANIA</option>
            </select>
            <div id="imp-settings" class="hidden">
                <label>Impostorzy:</label>
                <select id="select-imp-count"><option value="1">1</option><option value="2">2</option></select>
            </div>
            <button class="btn-green" onclick="startGame()">START</button>
        </div>
        <p id="guest-msg">Czekanie na hosta...</p>
    </div>

    <div id="screen-imp-karty" class="container hidden">
        <h3>Twoja Karta:</h3>
        <div class="player-card" onclick="this.classList.toggle('flipped')">
            <div class="card-front">ODKRYJ</div>
            <div id="card-back-content" class="card-back"></div>
        </div>
        <button class="btn-opt" onclick="exitGame()">OPUŚĆ</button>
    </div>

    <div id="screen-imp-pytania" class="container hidden">
        <h2 id="imp-role-display">Rola</h2>
        <p id="imp-q-display" style="background:#2a2a2a; padding:15px; border-radius:10px;"></p>
        <input type="text" id="imp-ans-input" placeholder="Twoja odpowiedź...">
        <button class="btn-green" id="btn-imp-send" onclick="sendImpAnswer()">WYŚLIJ</button>
    </div>

    <div id="screen-the-test" class="container hidden">
        <div class="progress-bar"><div id="test-progress" class="progress-fill" style="width: 0%"></div></div>
        <h2 id="test-role-title">Twoja kolej</h2>
        <p id="test-status" style="color: #ffc107;"></p>
        <p id="test-q-text" style="font-size: 1.2em; font-weight: bold;"></p>
        <div id="test-options"></div>
    </div>

    <div id="screen-results" class="container hidden">
        <h2 id="res-title">Wyniki</h2>
        <div id="res-content" style="text-align:left; margin: 15px 0;"></div>
        <div id="host-reveal-btn" class="hidden">
            <button class="btn-opt" style="border-color:var(--danger)" onclick="revealImp()">ODKRYJ IMPOSTORA</button>
        </div>
        <button class="btn-blue" onclick="exitGame()">POWRÓT</button>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAQLLZui2v4j3nLLKXhp2brcqsgSyy0W2s",
            databaseURL: "https://menu-gier-default-rtdb.europe-west1.firebasedatabase.app",
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let myName, myRoom, isHost = false;

        // BAZA DANYCH
        const POOL_KARTY = [{ word: "Lotnisko", hint: "Samolot, Kontrola" }, { word: "Kawa", hint: "Kubek, Pobudzenie" }];
        const POOL_IMP_PYTANIA = [
            { name: "Jazda", CREWMATE: "Kto pierwszy spowodowałby wypadek?", IMPOSTOR: "Kto jest najbardziej opanowanym kierowcą?" },
            { name: "Więzienie", CREWMATE: "Kto najszybciej trafiłby do więzienia?", IMPOSTOR: "Kto ma najbardziej niewinną twarz?" }
        ];
        const POOL_TEST = [
            { q: "Gdzie widzisz się za 10 lat?", o: ["Biznes", "Podróże", "Rodzina"] },
            { q: "Idealny wieczór?", o: ["Impreza", "Netflix", "Hobby"] }
        ];

        function handleAuth(mode) {
            myName = document.getElementById('input-name').value.trim();
            myRoom = document.getElementById('input-room').value.trim();
            if(!myName || !myRoom) return alert("Uzupełnij dane!");
            
            const ref = db.ref('multigame/' + myRoom);
            ref.once('value').then(snap => {
                if(mode==='create') { isHost = true; ref.set({ host: myName, status: "LOBBY" }); }
                db.ref(`multigame/${myRoom}/players/${myName}`).set({ name: myName, ans: "" });
                document.getElementById('room-id-display').innerText = myRoom;
                if(isHost) document.getElementById('host-panel').classList.remove('hidden');
                showScreen('screen-lobby');
                startSync();
            });
        }

        function startSync() {
            db.ref(`multigame/${myRoom}`).on('value', snap => {
                const data = snap.val(); if(!data) return;
                const players = data.players || {};
                document.getElementById('playerList').innerText = "Gracze: " + Object.keys(players).join(", ");

                if(data.status === "STARTED_IMP") {
                    const me = players[myName];
                    if(data.mode === "KARTY") {
                        showScreen('screen-imp-karty');
                        const card = document.getElementById('card-back-content');
                        if(me.isImp) {
                            const hints = data.set.hint.split(',');
                            card.innerText = "IMPOSTOR\nPodpowiedź: " + (hints[0]);
                            card.className = "card-back impostor-bg";
                        } else {
                            card.innerText = "HASŁO:\n" + data.set.word;
                            card.className = "card-back crew-bg";
                        }
                    } else {
                        showScreen('screen-imp-pytania');
                        document.getElementById('imp-role-display').innerText = me.isImp ? "IMPOSTOR" : "ZAŁOGANT";
                        document.getElementById('imp-q-display').innerText = me.isImp ? data.set.IMPOSTOR : data.set.CREWMATE;
                    }
                } 
                else if(data.status === "STARTED_TEST") {
                    showScreen('screen-the-test');
                    updateTestUI(data);
                }
                else if(data.status === "RESULTS") showResults(data);
            });
        }

        function toggleImpSettings() {
            const mode = document.getElementById('select-mode').value;
            document.getElementById('imp-settings').className = mode.includes('IMPOSTOR') ? "" : "hidden";
        }

        function startGame() {
            const mode = document.getElementById('select-mode').value;
            const ref = db.ref(`multigame/${myRoom}`);
            ref.child('players').once('value', snap => {
                const pObj = snap.val(); const names = Object.keys(pObj);
                
                if(mode.includes('IMPOSTOR')) {
                    const impCount = parseInt(document.getElementById('select-imp-count').value);
                    const shuffled = names.sort(() => 0.5 - Math.random());
                    const imps = shuffled.slice(0, impCount);
                    const set = mode === "IMPOSTOR_KARTY" ? POOL_KARTY[Math.floor(Math.random()*POOL_KARTY.length)] : POOL_IMP_PYTANIA[Math.floor(Math.random()*POOL_IMP_PYTANIA.length)];
                    
                    let updates = { status: "STARTED_IMP", mode: mode.split('_')[1], set: set, revealed: false };
                    names.forEach(n => { updates[`players/${n}/isImp`] = imps.includes(n); updates[`players/${n}/ans`] = ""; });
                    ref.update(updates);
                } else {
                    ref.update({ status: "STARTED_TEST", qList: POOL_TEST.sort(()=>0.5-Math.random()).slice(0,3), currentRound: 0, step: "ASKING", scores: 0, activeIdx: 0 });
                }
            });
        }

        // LOGIKA THE TEST
        function updateTestUI(data) {
            const players = Object.keys(data.players);
            const active = players[data.activeIdx]; const guesser = players[1-data.activeIdx];
            const q = data.qList[data.currentRound];
            document.getElementById('test-progress').style.width = (data.currentRound / data.qList.length * 100) + "%";
            document.getElementById('test-q-text').innerText = q.q;
            const optArea = document.getElementById('test-options'); optArea.innerHTML = "";

            if(data.step === "ASKING") {
                document.getElementById('test-status').innerText = myName === active ? "ODPOWIEDZ O SOBIE" : `Czekaj na ${active}...`;
                if(myName === active) renderTestOpts(q.o, 'A');
            } else {
                document.getElementById('test-status').innerText = myName === guesser ? `CO WYBRAŁ ${active}?` : `Czekaj na ${guesser}...`;
                if(myName === guesser) renderTestOpts(q.o, 'B');
            }
        }

        function renderTestOpts(opts, type) {
            opts.forEach(o => {
                const b = document.createElement('button'); b.className = "btn-opt"; b.innerText = o;
                b.onclick = () => {
                    const ref = db.ref(`multigame/${myRoom}`);
                    if(type==='A') ref.update({ step: "GUESSING", lastAnsA: o });
                    else ref.once('value', s => {
                        const d = s.val();
                        let score = d.scores + (d.lastAnsA === o ? 1 : 0);
                        let next = d.currentRound + 1;
                        if(next >= d.qList.length) ref.update({ status: "RESULTS", scores: score, testFinished: true });
                        else ref.update({ step: "ASKING", currentRound: next, scores: score });
                    });
                };
                document.getElementById('test-options').appendChild(b);
            });
        }

        // IMPOSTOR ANSWERS
        function sendImpAnswer() {
            const val = document.getElementById('imp-ans-input').value;
            db.ref(`multigame/${myRoom}/players/${myName}`).update({ ans: val }).then(() => {
                document.getElementById('btn-imp-send').classList.add('hidden');
                db.ref(`multigame/${myRoom}`).once('value', s => {
                    if(Object.values(s.val().players).every(p => p.ans !== "")) db.ref(`multigame/${myRoom}`).update({ status: "RESULTS" });
                });
            });
        }

        function showResults(data) {
            showScreen('screen-results');
            const area = document.getElementById('res-content'); area.innerHTML = "";
            if(data.testFinished) {
                const pct = Math.round(data.scores / data.qList.length * 100);
                area.innerHTML = `<h1 style="text-align:center">${pct}%</h1><p style="text-align:center">Zgodności!</p>`;
            } else {
                if(isHost && !data.revealed) document.getElementById('host-reveal-btn').classList.remove('hidden');
                Object.values(data.players).forEach(p => {
                    let role = (data.revealed && p.isImp) ? `<span class="reveal-text">IMP</span>` : "";
                    area.innerHTML += `<p><b>${p.name}:</b> ${p.ans} ${role}</p>`;
                });
            }
        }

        function revealImp() { db.ref(`multigame/${myRoom}`).update({ revealed: true }); }
        function exitGame() { location.reload(); }
        function showScreen(id) { document.querySelectorAll('.container').forEach(c => c.classList.add('hidden')); document.getElementById(id).classList.remove('hidden'); }
    </script>
</body>
</html>
